\chapter{Integração Redmine e Activiti BPM}\label{chp:integracao_redmine_activiti}

\section{Introdução}\label{sec:integracao_redmine_activiti-introducao}
Dadas as vantagens e limitações das ferramentas Activiti e Redmine utilizadas como plataformas para a automatização de processos, decidimos desenvolver uma forma de integrá-las para explorarmos os pontos positivos de cada uma delas.

Para atingir este objetivo, criamos um plugin para o Redmine que possibilita a comunicação com o Activiti. Nas próximas sessões, descreveremos o processo de construção deste plugin e como utilizá-lo.


\section{Customização do Redmine}\label{sec:integracao_redmine_activiti-implementacao}

A integração tem por objetivo centralizar o máximo de funcionalidades no Redmine, deixando transparente tanto para o usuário comum como o gestor, a existência de um motor BPM por trás.

\subsection{Funcionalidades}\label{sec:integracao_redmine_activiti_implementacao_funcionalidades}
\subsubsection{Conexão com o Activiti }\label{sec:integracao_redmine_activiti_inplementacao_funcionalidades_conexão}
Para iniciar a utilização do plugin é necessário configurar os detalhes para conexão com o Activiti BPM.
Após colocar o servidor, login e senha, também é preciso disparar os jobs que rodam continuamente para sincronizar os processos e tarefas entre o Redmine e o Activiti.

\subsubsection{Configuração dos estados}\label{sec:integracao_redmine_activiti_inplementacao_funcionalidades_conexão}
Também é necessário configurar os estados principais a serem utilizados pelo plugin.
Configure os estados padrão que devem ser utilizados quando um processo é criado, concluído ou está em andamento.

\subsubsection{Deploy de um processo}\label{sec:integracao_redmine_activiti_inplementacao_funcionalidades_deploy}
Como já foi explicado, o processo deve ser modelado na notação BPMN. Mas à partir deste ponto, toda a interação será através do Redmine.
Na tela de processos, ao clicar em Novo processo, é possível fazer upload de uma modelagem de um processo para o Redmine. Esta operação tenta o deploy do arquivo selecionado no Activiti, através do serviço REST e apresenta o resultado na tela.

A cada vez que esta tela é atualizada, a lista de processos é atualizada. Nela são mostrados todo os fluxos de trabalho ativos no BPMS, inclusive os que não foram instalados através da interface citada acima. Ao clicar numa linha, o usuário consegue visualizar o diagrama do processo.

É possível efetuar o deploy da mesma definição de processo mais de uma vez, caso sejam feitas alterações no fluxo. Neste caso, o novo deploy será identificado como uma nova versão do mesmo processo. 

\subsubsection{Configuração de um processo}\label{sec:integracao_redmine_activiti_inplementacao_funcionalidades_configuracao}
A integração das duas ferramentas se dá na sincronização dos processos e tarefas humanas do Activiti. A representação para elas que foi implementada no Redmine é explicada nas duas seções a seguir:

\begin{itemize}
\item \textbf{Representação de um processo} - Um fluxo de um processo modelado e instalado no Activiti é chamado de definição de processo. No Redmine, o tipo da tarefa representa a definição de processo, e determinará qual o processo que é disparado na criação de uma tarefa. Uma instância (a materialização de uma definição de processo) de um processo no BPMS é iniciada pela criação de uma tarefa no Redmine. Durante toda a vida de um processo, este é representado pela tarefa que deu início a ele. 

\item \textbf{Representação de uma tarefa humana} - Quando um fluxo vai para uma etapa de tarefa humana, é criado uma tarefa no Redmine para representá-la e aonde a interação necessária com o usuário acontecerá. Esta tarefa será filha da tarefa que representa a instância do processo em questão.
\end{itemize}

A primeira configuração a ser feita consiste em definir qual o tipo de tarefa estará conectado ao processo sendo editado. Além disso, é exibida a lista de versões do processo selecionado, e qual a versão ativa. Ao estabelecer esta conexão, toda tarefa deste tipo criada no Redmine disparará uma instância dessa definição de processo no Activiti, na versão ativa marcada.
Na mesma tela também é possível redefinir o nome que aparece na lista de processos.

O próximo passo é editar uma versão para configurar mais detalhes:

\begin{itemize}
\item \textbf{Ativo} - Como explicado anteriormente, ao marcar esta opção, o usuário estabelece a versão padrão que deve ser disparada pelas tarefas conectadas a este processo.

\item \textbf{Variáveis do processo} - Numa definição de um processo podem ser definidas diferentes variáveis a serem usadas para definir o status ou responsável de uma tarefa, para preencher automaticamente um campo ou tomada de decisão. Devem ser preenchidos os valores para essas variáveis utilizadas no processo de acordo com o tipo definido.

\item \textbf{Estados de conclusão do processo} - 
Na modelagem do processo podem ser configurados diferentes eventos de término. Nesta seção são configurados quais status no Redmine vão representar cada evento.

\item \textbf{Configuração das tarefas do processo} - 
Aqui são listadas as etapas do tipo tarefa humana presentes na modelagem. Para cada uma é possível definir o status com o qual deve ser criada cada sub-tarefa que representa a tarefa humana em questão, e definir um tipo de tarefa diferente para cada uma. Caso o campo \textbf{Tipo} não seja preenchido, a sub-tarefa será do mesmo tipo da tarefa original. Caso contrário, a sub-tarefa terá o tipo definido, que pode ser usado para representar um novo processo.

\item \textbf{Campos personalizados utilizados pelo processo} - Na modelagem, o evento de inicialização, bem como as tarefas humanas de um processo possuem campos de formulário. Os valores destes campos são sincronizados junto com as tarefas do Redmine para o Activiti e vice-versa. Para guardar estes campos nas tarefas do Redmine são utilizados campos personalizados. Nesta seção portanto, deve ser selecionado cada campo customizado que representará os campos definidos no processo.

\end{itemize}

\subsection{Detalhes do desenvolvimento}\label{sec:integracao_redmine_activiti_implementacao_detalhes_desenvolvimento}

\subsubsection{Linguagens}\label{sec:integracao_redmine_activiti_implementacao_detalhes_desenvolvimento_linguagens}

O plugin desenvolvido para Redmine foi desenvolvido em Ruby\cite{ruby-lang}, utilizando a framework Rails\cite{rails}. A linguagem open source e orientada a objetos, disponibilizada ao público em 1995, foi criada por Yukihiro “Matz” Matsumoto, inspirada nas linguagens Perl, Smalltalk, Eiffel, Ada e Lisp, suas linguagens preferidas. Em 2006, o Ruby atingiu aceitação massiva, com a formação de grupos de usuários em todas as principais cidades do mundo e com as conferências sobre Ruby com lotação esgotada. Ruby está entre as 10 linguagens mais populares, segundo o índice TIOBE\cite{tiobe} de abril de 2016, que se baseia nas buscas com o nome da linguagem como palavra chave. A framework Rails é uma biblioteca (ou gema) que extende de Ruby. Foi criada por David Heinemeier Hansson em 2004 para a utilização desta linguagem para o desenvolvimento de aplicações web. Isto é feito através da comunicação da comunicação do Ruby com HTML, CSS e Javascript.

As modificações feitas no Activiti foram feitas em Java, a linguagem que em que este foi desenvolvido. Criado em 1995 por um time da Sun (chamado de "Green Team"), Java\cite{java-history} é uma linguagem interpretada orientada a objetos,  que é independente de plataforma, pois sempre executa na JVM (Java Virtual Machine). Segundo o índice TIOBE de abril de 2016 é a linguagem mais popular no mundo.

\subsubsection{Banco de dados}\label{sec:integracao_redmine_activiti_implementacao_detalhes_desenvolvimento_bd}

\subsubsection{Sincronizacao}\label{sec:integracao_redmine_activiti_implementacao_detalhes_desenvolvimento_sincronizacao}

\paragraph{Definição de processo}

% Ao fazer o deploy de um processo através da interface do Redmine é disparado um serviço que acessa a API REST do Activiti, executando uma requisição POST que efetivamente executa o deploy, adicionando a modelagem do processo em questão à lista de definições de processos ativos, que podem ser iniciados.

% O código a seguir monta a requisição POST repository/deployments enviando o arquivo .bpmn, que retorna o deployment\_id do processo cujo deploy acaba de ser feito.

% \codejava{Ruby}{alg:LABEL_CODE_5}{codigos/deploy_process.rb}


% Após executado o serviço é iniciado um job que acessa, através de um outro serviço que busca a definição à partir do deployment\_id. As informações do processo que são recuperadas consistem das tarefas humanas definidas, campos de formulário, variáveis de processo e outros detalhes.

% O código a seguir monta a requisição GET que recupera a definição de um processo.

% \codejava{Ruby}{alg:LABEL_CODE_4}{codigos/process_definition_by_deployment_id.rb}

% O código a seguir consiste do job que centraliza a sincronização de uma definição de processo no momento do deploy. 

% \codejava{Ruby}{alg:LABEL_CODE_3}{codigos/sinchronize_process_definition_job.rb}


\paragraph{Tarefas humanas}\label{sec:integracao_redmine_activiti_implementacao_detalhes_desenvolvimento_sincronizaca_human_task}

\paragraph{Inicialização de um processo}\label{sec:integracao_redmine_activiti_implementacao_detalhes_desenvolvimento_sincronizacao_processo}
% Sempre que uma tarefa é criada, caso ela esteja vinculada a um processo BPM, um serviço é disparado. Este serviço executa 


\subsubsection{Configuracao do processo}\label{sec:integracao_redmine_activiti_implementacao_detalhes_desenvolvimento_configuracao}
% Escrever sobre os detalhes de como modelar um processo que se comunica com o Redmine

\section{Customização do Activiti}\label{sec:integracao_redmine_activiti-implementacao-activiti}

A integração entre o Redmine e o Activiti BPM foi desenvolvida sob o aspecto de direcionar a maior parte das customizações para o lado do Redmine, uma vez que esta é apenas uma das possibilidades de interface com o motor de processos. Num cenário mais amplo de processos mais complexos, outros tipos de dispositivos ou sistemas poderiam realizar uma comunicação direta com os processos.

A API REST padrão oferecida pelo Activiti foi utilizada para a integração entre as ferramentas, uma vez que é bem completa e oferece a maioria dos serviços necessários para a comunicação. Também contou a facilidade de chamadas a APIs REST pelo Ruby on Rails. 

Entretanto, identificamos a ausência de um serviço fundamental para integração entre as ferramentas. Esse serviço deveria retornar uma lista contendo as definições de tarefas contidas em um determinado processo, incluindo os campos disponíveis nos formulários das tarefas. Essa definição nos permitiria estabelecer a interface para o mapeamento dos campos do processo com os campos das tarefas do Redmine.

Sendo assim, extendemos a API REST do Activiti, através da criação de um classe Java representando um novo serviço, semelhante aos serviços existentes no seu código-fonte. Esse serviço consistiu no consumo de uma API Java já disponibilizada pelo Activiti, mas ausente na API REST. O código-fonte simplificado desta classe pode ser observado abaixo:

\codejava{Java}{alg:LABEL_CODE_2}{codigos/TaskDefinitionService.java}

\section{Resultados}\label{sec:integracao_redmine_activiti-resultados}